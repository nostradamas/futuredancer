/*
 * This build file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/3.3/userguide/tutorial_java_projects.html
 */
apply plugin: 'org.hidetake.ssh'
sourceSets {
     main.java.srcDirs = ['src/main/java']
     main.resources.srcDirs = ['src/main/resources']
}

processResources {
	from('src/main/java') {
        include 'com/fdw/persist/dao/Mapper/**'
   }}
war {
	archiveName 'futuredancer.war'
}
buildscript{
    repositories {
        jcenter()
        mavenCentral()
    }
	dependencies {
	    classpath 'org.hidetake:gradle-ssh-plugin:2.6.0'
	}
}
ssh.settings {
  knownHosts = allowAnyHosts
}

remotes {
  deployServer {
    host = '139.224.17.141'
    user = 'root'
    password = 'Future!@#$'
  }
}

task shutdownTomcat() << {
  ssh.run {
    session(remotes.deployServer) {
      println 'shut down tomcat...'
      executeScript '''#!/bin/sh
                        cd /usr/tomcat/apache-tomcat-8.5.13/bin
                        ./shutdown.sh
                    '''
    }
  }
}

task del(dependsOn:shutdownTomcat) << {
  ssh.run {
    session(remotes.deployServer) {
      println 'start deleting...'
      executeScript '''#!/bin/sh
                        rm -rf /usr/tomcat/apache-tomcat-8.5.13/webapps/futuredancer
                        rm -f /usr/tomcat/apache-tomcat-8.5.13/webapps/futuredancer.war
                    '''
    }
  }
}

task copy(dependsOn:del) << {
  ssh.run {
    session(remotes.deployServer) {
      println 'start copying war...'
      put from: buildDir.toString() + '/libs/futuredancer.war', into: '/usr/tomcat/apache-tomcat-8.5.13/webapps'
    }
  }
}

task deploy(dependsOn:copy) << {
  ssh.run {
    session(remotes.deployServer) {
      println 'start tomcat...'
      execute '/usr/tomcat/apache-tomcat-8.5.13/bin/startup.sh'
    }
  }
}

